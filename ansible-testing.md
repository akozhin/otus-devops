# Разработка и тестирование Ansible ролей и плейбуков

## План 

* Локальная разработка при помощи Vagrant,доработка ролей для провижининга в Vagrant
* Тестирование ролей при помощи Molecule и Testinfra
* Переключение сбора образов пакером на использование ролей
* Подключение Travis CI для автоматического прогона тестов

## Vagrant


```bash
vagrant up
vagrant box list
vagrant status
```

[Vagrant Provisioning](https://www.vagrantup.com/docs/provisioning/)

Провижининг происходит автоматически при запуске новой машины. Если же мы хотим применить провижининг на уже запущенной машине, то необходимо использовать команду provision. Если мы хотим применить команду для конкретного хоста, то нам также нужно передать его имя в качестве аргумента.

```bash
vagrant provision dbserver
```

```python
ansible.groups = {
	"app" => ["appserver"],
	"app:vars" => { "db_host" => "10.10.10.10"}
}
```
Vagrant динамически генерирует инвентори файл для провижининга в соответствии с конфигурацией в Vagrantfile.
То есть передавая опции выше, у нас будет создаваться группа [app], в которой будет один хост appserver (что соответсвует создаваемой VM). Далее мы определяем переменные для данной группы app. 

```bash
cat .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory
# Generated by Vagrant

dbserver ansible_host=127.0.0.1 ansible_port=2222 ansible_user='ubuntu' ansible_ssh_private_key_file='/Users/akozhin/work/devops/akozhin_infra/ansible/.vagrant/machines/dbserver/virtualbox/private_key'
appserver ansible_host=127.0.0.1 ansible_port=2200 ansible_user='ubuntu' ansible_ssh_private_key_file='/Users/akozhin/work/devops/akozhin_infra/ansible/.vagrant/machines/appserver/virtualbox/private_key'

[db]
dbserver

[db:vars]
mongo_bind_ip=0.0.0.0

```

[Приоритеты переменных ansible](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable)